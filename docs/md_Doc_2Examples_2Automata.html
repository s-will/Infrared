<!-- HTML header for doxygen 1.9.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infrared: Automata to forbid/enforce sequence motifs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<!--  -->
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Infrared
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_Doc_2Examples_2Automata.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Automata to forbid/enforce sequence motifs</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md126">Online resources and software environment</a></li>
<li class="level1"><a href="#autotoc_md128">Enforcing and forbidding sequence motifs by finite deterministic automata</a></li>
<li class="level1"><a href="#autotoc_md129">Construction of an Aho-Corasick automaton</a><ul><li class="level2"><a href="#autotoc_md130">Construct for specific instance and visualize</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md131">Automaton feature network</a></li>
<li class="level1"><a href="#autotoc_md132">Model for our example</a></li>
<li class="level1"><a href="#autotoc_md133">APPENDIX</a></li>
<li class="level1"><a href="#autotoc_md134">Combination with multi-target design</a></li>
<li class="level1"><a href="#autotoc_md135">Compute the tree decomposition - compare different strategies</a><ul><li class="level2"><a href="#autotoc_md136">Minimize tree width</a></li>
<li class="level2"><a href="#autotoc_md137">Minimize tree width after &#39;collapsing&#39; corresponding variables</a></li>
<li class="level2"><a href="#autotoc_md138">Optimize weight over tree decompositions with low tree width (from min-fill-in)</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md124"></a></p>
<hr  />
<h1><a class="anchor" id="autotoc_md126"></a>
Online resources and software environment</h1>
<p>​</p>
<p>This document is hosted online as <a href="https://www.lix.polytechnique.fr/~will/Software/Infrared/current/Doc/Automata.ipynb">Jupyter notebook</a> with precomputed results. Download this file to view, edit and run examples in Jupyter.</p>
<p>​</p>
<p>We recommend to install all required software using Mamba (or Conda) and PIP.</p>
<div class="fragment"><div class="line">mamba create -n infrared -c conda-forge infrared jupyter jupytext matplotlib seaborn graphviz</div>
<div class="line"> </div>
<div class="line">mamba activate infrared</div>
<div class="line"> </div>
<div class="line">pip install graphviz</div>
<div class="line"> </div>
<div class="line">mamba deactivate infrared</div>
</div><!-- fragment --><p>​</p>
<p>Start the Jupyter notebook server after activating the environment</p>
<div class="fragment"><div class="line">mamba activate infrared</div>
<div class="line"> </div>
<div class="line">jupyter notebook</div>
</div><!-- fragment --><p>The <a href="https://gitlab.inria.fr/amibio/Infrared/-/tree/master/Doc/Examples">original sources</a> are part of the Infrared distribution and hosted on Gitlab (in Jupytext light Script format).</p>
<p>​</p>
<hr  />
<h1><a class="anchor" id="autotoc_md128"></a>
Enforcing and forbidding sequence motifs by finite deterministic automata</h1>
<p>We showcase an Infrared feature network model that forbids (or enforces) the occurrence of any (respectively one) of several given input motifs in randomly generated sequences. The Infrared model is be based on a finite automaton that we construct from the input motifs/words.</p>
<p>For example, let's generate sequences that avoid the stop codons or any of three restriction sites of EcoRI, BamHI, and HindIII</p>
<div class="fragment"><div class="line">Sigma=<span class="stringliteral">&quot;ACGU&quot;</span></div>
<div class="line"> </div>
<div class="line">stop_codons = [<span class="stringliteral">&quot;UGA&quot;</span>, <span class="stringliteral">&quot;UAG&quot;</span>, <span class="stringliteral">&quot;UAA&quot;</span>]</div>
<div class="line"> </div>
<div class="line">restriction_sites = [<span class="stringliteral">&quot;GAAUUC&quot;</span>,</div>
<div class="line">                     <span class="stringliteral">&quot;GGAUCC&quot;</span>,</div>
<div class="line">                     <span class="stringliteral">&quot;AAGCUU&quot;</span></div>
<div class="line">                    ]</div>
<div class="line"> </div>
<div class="line">words=stop_codons</div>
<div class="line"><span class="comment">#words=restriction_sites</span></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="keyword">import</span> infrared <span class="keyword">as</span> ir</div>
<div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div>
</div><!-- fragment --><p>A <em>Deterministic Finite Automaton (DFA)</em> is a \(5\)-tuple \((\mathcal{Q},\Sigma,\delta,q_0,\mathcal{Q}_F)\) with</p>
<ul>
<li>Finite set of states \(\mathcal{Q}\);</li>
<li>Finite set of symbols \(\Sigma\);</li>
<li>Transition function \(\delta:\mathcal{Q}\times\Sigma\to\mathcal{Q}\);</li>
<li>Initial state \(q_0\in\mathcal{Q}\);</li>
<li>Set of final, accepting states \(\mathcal{Q}_F\subset\mathcal{Q}\).</li>
</ul>
<h1><a class="anchor" id="autotoc_md129"></a>
Construction of an Aho-Corasick automaton</h1>
<p>We construct a specific DFA, called <em>Aho-Corasick automaton</em>, that accepts strings that contain one of several given words. The general idea of this construction is that the automaton contains one state for every true word prefix; in addition there is a terminal state $. Then, we introduce transitions from states so that the automaton always remembers the longest infix up to current position that can still be extended to an accepted word.</p>
<div class="fragment"><div class="line"><span class="keyword">def </span>maxoverlap(s,t):</div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> reversed(range(min(len(s),(len(t)))+1)):</div>
<div class="line">        <span class="keywordflow">if</span> s[-i:] == t[:i]:</div>
<div class="line">            <span class="keywordflow">return</span> i</div>
<div class="line">    <span class="keywordflow">return</span> 0</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>construct_automaton(words, Sigma):</div>
<div class="line">    <span class="comment">#</span></div>
<div class="line">    states = set()</div>
<div class="line">    <span class="keywordflow">for</span> w <span class="keywordflow">in</span> words:</div>
<div class="line">        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,len(w)):</div>
<div class="line">            states.add(w[:i])</div>
<div class="line"> </div>
<div class="line">    states.add(<span class="stringliteral">&quot;$&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># construct transition table as dictionary delta[state][c] = nextstate</span></div>
<div class="line">    delta = defaultdict(dict)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> state <span class="keywordflow">in</span> states:</div>
<div class="line">        <span class="keywordflow">if</span> state==<span class="stringliteral">&quot;$&quot;</span>:</div>
<div class="line">            <span class="keywordflow">for</span> c <span class="keywordflow">in</span> Sigma:</div>
<div class="line">                delta[state][c]=<span class="stringliteral">&quot;$&quot;</span></div>
<div class="line">            <span class="keywordflow">continue</span></div>
<div class="line">        <span class="keywordflow">for</span> c <span class="keywordflow">in</span> Sigma:</div>
<div class="line">            s = state+c</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> s <span class="keywordflow">in</span> words:</div>
<div class="line">                delta[state][c] = <span class="stringliteral">&quot;$&quot;</span></div>
<div class="line">                <span class="keywordflow">continue</span></div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> s <span class="keywordflow">in</span> states:</div>
<div class="line">                delta[state][c] = s</div>
<div class="line">                <span class="keywordflow">continue</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment"># find smallest state with largest overlap</span></div>
<div class="line">            xs = []</div>
<div class="line">            <span class="keywordflow">for</span> state2 <span class="keywordflow">in</span> states:</div>
<div class="line">                k = maxoverlap(s,state2)</div>
<div class="line">                xs.append((state2,k))</div>
<div class="line">            <span class="keywordflow">if</span> len(xs)&gt;0:</div>
<div class="line">                maxk = max(x[1] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> xs)</div>
<div class="line">                maxstates = [x[0] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> xs <span class="keywordflow">if</span> x[1]==maxk]</div>
<div class="line">                state2=min(maxstates, key=<span class="keyword">lambda</span> x: len(x))</div>
<div class="line">                delta[state][c]=state2</div>
<div class="line">    <span class="keywordflow">return</span> (states,delta)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md130"></a>
Construct for specific instance and visualize</h2>
<p>As preparation step, to finally forbid the restriction sites, we are first construting a DFA that recognizes them.</p>
<div class="fragment"><div class="line">automaton = construct_automaton(words, Sigma)</div>
<div class="line"> </div>
<div class="line">snum = len(automaton[0])</div>
<div class="line">print(f<span class="stringliteral">&#39;{snum} states&#39;</span>)</div>
</div><!-- fragment --> <pre class="fragment">5 states
</pre><div class="fragment"><div class="line"><span class="keyword">import</span> graphviz</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>draw_automaton(automaton):</div>
<div class="line">    states,delta = automaton</div>
<div class="line">    </div>
<div class="line">    G=graphviz.Digraph(engine=<span class="stringliteral">&quot;dot&quot;</span>,</div>
<div class="line">    graph_attr=dict(),</div>
<div class="line">    node_attr=dict(fontsize=<span class="stringliteral">&quot;22pt&quot;</span>, fontname=<span class="stringliteral">&quot;Helvetica&quot;</span>,</div>
<div class="line">                   penwidth=<span class="stringliteral">&quot;3.0&quot;</span>, fontcolor=<span class="stringliteral">&quot;black&quot;</span>,</div>
<div class="line">                   shape=<span class="stringliteral">&quot;rectangle&quot;</span>, style=<span class="stringliteral">&quot;rounded&quot;</span>,</div>
<div class="line">                   height=<span class="stringliteral">&quot;0.4&quot;</span>, margin=<span class="stringliteral">&quot;0.03&quot;</span>),</div>
<div class="line">    edge_attr=dict(color=<span class="stringliteral">&quot;gray30&quot;</span>, penwidth=<span class="stringliteral">&quot;1.5&quot;</span>, arrowsize=<span class="stringliteral">&quot;0.8&quot;</span>))</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> state <span class="keywordflow">in</span> states:</div>
<div class="line">        G.node(state)</div>
<div class="line">    <span class="keywordflow">for</span> src <span class="keywordflow">in</span> delta:</div>
<div class="line">        tgts = defaultdict(list)</div>
<div class="line">        <span class="keywordflow">for</span> c <span class="keywordflow">in</span> delta[src]:</div>
<div class="line">            tgt = delta[src][c]</div>
<div class="line">            tgts[tgt].append(c)</div>
<div class="line">        <span class="keywordflow">for</span> tgt,c <span class="keywordflow">in</span> tgts.items():</div>
<div class="line">            G.edge(src,tgt,label=<span class="stringliteral">&#39;,&#39;</span>.join(sorted(c)))</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> G</div>
</div><!-- fragment --><div class="fragment"><div class="line">draw_automaton(automaton)</div>
</div><!-- fragment --><p><img src="Automata_files/Automata_11_0.svg" alt="svg" style="pointer-events: none;" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md131"></a>
Automaton feature network</h1>
<p>We 'implement' the automaton as Infrared model, by modeling the state at each position by a variable (whose value is the state index) and the transitions by constraints. For use in our model, we define a constraint to express the transition function \(\delta\). To express our model in Infrared, states (and characters) have to be encoded as integers. Thus, before we can express the model, we translate our automaton (including its transition function) to this encoding.</p>
<div class="fragment"><div class="line">ir.def_constraint_class(<span class="stringliteral">&#39;Trans&#39;</span>,</div>
<div class="line">    <span class="keyword">lambda</span> i,delta,var: var([(<span class="stringliteral">&#39;X&#39;</span>,i),(<span class="stringliteral">&#39;Y&#39;</span>,i),(<span class="stringliteral">&#39;Y&#39;</span>,i+1)]),</div>
<div class="line">    <span class="keyword">lambda</span> xi,yi,yip1,delta: yip1 == delta[yi][xi])</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>automaton_to_int_encoding(automaton, Sigma):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;Convert automaton to an integer encoding</span></div>
<div class="line"><span class="stringliteral">    </span></div>
<div class="line"><span class="stringliteral">    Returns:</span></div>
<div class="line"><span class="stringliteral">        (revintstates, intdelta), where</span></div>
<div class="line"><span class="stringliteral">          * revinstates represents the states </span><span class="keyword">as</span> a mapping <span class="keyword">from</span> state labels to integers</div>
<div class="line">          * intdelta <span class="keywordflow">is</span> the delta function on integers <span class="keywordflow">for</span> states <span class="keywordflow">and</span> characters (w.r.t. Sigma)</div>
<div class="line">          </div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    states, delta = automaton</span></div>
<div class="line"><span class="stringliteral">    </span></div>
<div class="line"><span class="stringliteral">    </span></div>
<div class="line"><span class="stringliteral">    states=list(states)</span></div>
<div class="line"><span class="stringliteral">    </span><span class="comment"># ensure that the termination state is the last state</span></div>
<div class="line">    termidx = states.index(<span class="stringliteral">&#39;$&#39;</span>)</div>
<div class="line">    states[termidx],states[-1] = states[-1],states[termidx]</div>
<div class="line">    </div>
<div class="line">    numstates = len(states)</div>
<div class="line">    </div>
<div class="line">    revintstates = {state:x <span class="keywordflow">for</span> x,state <span class="keywordflow">in</span> enumerate(states)}</div>
<div class="line">        </div>
<div class="line">    intdelta = defaultdict(dict)</div>
<div class="line">    <span class="keywordflow">for</span> src <span class="keywordflow">in</span> delta:</div>
<div class="line">        <span class="keywordflow">for</span> c <span class="keywordflow">in</span> delta[src]:</div>
<div class="line">            tgt = delta[src][c]</div>
<div class="line">            intdelta[revintstates[src]][Sigma.index(c)] = revintstates[tgt]</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> revintstates, intdelta</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line"><span class="keyword">def </span>automaton_model(n, Sigma, automaton, model=None, negated=False):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    Construct automaton model</span></div>
<div class="line"><span class="stringliteral">    Args:</span></div>
<div class="line"><span class="stringliteral">       Sigma: alphabet</span></div>
<div class="line"><span class="stringliteral">       automaton: actually, only the pair of states </span><span class="keywordflow">and</span> delta of an AC automaton, implicit start at <span class="stringliteral">&#39;&#39;</span></div>
<div class="line">       negated: <span class="keywordflow">if</span> <span class="keyword">False</span>, choose <span class="stringliteral">&#39;$&#39;</span> <span class="keyword">as</span> accepting; <span class="keywordflow">if</span> <span class="keyword">True</span>, every other state</div>
<div class="line">       model: <span class="keywordflow">if</span> this <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>, extend the given model by the automaton.</div>
<div class="line">           Given models must define n variables X_i, which encode alphabet characters.</div>
<div class="line">    Returns:</div>
<div class="line">        The constructed model</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    </span></div>
<div class="line"><span class="stringliteral">    </span><span class="comment"># sort the alphabet</span></div>
<div class="line">    Sigma = sorted(Sigma)</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># unless a model is already provided, construct it</span></div>
<div class="line">    <span class="comment"># ()</span></div>
<div class="line">    <span class="keywordflow">if</span> model <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">        model = ir.Model()</div>
<div class="line">        model.add_variables(n, len(Sigma), name=<span class="stringliteral">&#39;X&#39;</span>)</div>
<div class="line">    </div>
<div class="line">    states, delta = automaton_to_int_encoding(automaton, Sigma)</div>
<div class="line">    </div>
<div class="line">    q0 = states[<span class="stringliteral">&#39;&#39;</span>]</div>
<div class="line">    qf = states[<span class="stringliteral">&#39;$&#39;</span>]</div>
<div class="line">    </div>
<div class="line">    numstates = len(states)</div>
<div class="line">    </div>
<div class="line">    model.add_variables(1,   (q0,q0),<span class="stringliteral">&#39;Y&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> negated:</div>
<div class="line">        model.add_variables(n-1, numstates ,<span class="stringliteral">&#39;Y&#39;</span>)</div>
<div class="line">        model.add_variables(1,   (qf,qf), <span class="stringliteral">&#39;Y&#39;</span>)</div>
<div class="line">    <span class="keywordflow">else</span>:</div>
<div class="line">        model.add_variables(n, (0,qf-1) ,<span class="stringliteral">&#39;Y&#39;</span>)</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    model.add_constraints( Trans(i,delta,model.idx) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(n) )</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> model</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md132"></a>
Model for our example</h1>
<p>Construct the model for our example input words and use it to generate (uniformly drawn) sequences that avoid the input words!</p>
<div class="fragment"><div class="line">n=100</div>
<div class="line"><span class="keyword">def </span>a_to_seq(assignment, n, Sigma):</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>.join([Sigma[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sample.values()[:n]])</div>
<div class="line"> </div>
<div class="line">model = automaton_model(n, Sigma, automaton, negated=<span class="keyword">True</span>)</div>
</div><!-- fragment --><p>generate sequences and test whether they contain any input word (if above negated=True, then they must not occur; otherwise one of them must occur)</p>
<div class="fragment"><div class="line">sampler = ir.Sampler(model)</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(10):</div>
<div class="line">    sample = sampler.sample()</div>
<div class="line">    seq = a_to_seq(sample,n,Sigma)</div>
<div class="line">    print(seq)</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> w <span class="keywordflow">in</span> words:</div>
<div class="line">        <span class="keywordflow">if</span> w <span class="keywordflow">in</span> seq: </div>
<div class="line">            print(f<span class="stringliteral">&quot;    {w} occurs&quot;</span>)</div>
</div><!-- fragment --> <pre class="fragment">GAGGUACAAAGUGCUCUACCUCAGUCAUUAUCACGAUCUGGUAUACUACCCACCGAGUGUCAAAUGUUCCUGGACUGGGGGAUCGUUGCGGGCGUAUAUC
CCAAGAAGGACACGAACUCCAGGUUACACAUCAAUUCUGGCUAUCUUCUCAGGCGGCACUGUUUGCCACGAGAUUGUCCUACGAUCGGGAAGACGAGCCC
GGUUCCCGGCAACCCACGGAUCGUUCCACGGGAAGGAAUUUCACGCGGUUACUUGUAUUCAUAUGGCGCACGCCACCUUACGCUUAUUUCUUCGUGCCCA
ACUGCCAGAAAUUGCAGGAGUGGGGCCACCUGCCUCCAAUCGGUGUUCAGUCCACCUUCCGGCACAAGAGUCGACUUACACCUUCUCAAUCGCGUGCGAG
CACGGUUCAGUCGGAACACUGGCUCACACCUUAUGGGAAAGAAACACUUUCGACUUUGCUCCCAUCCCCGGCAAAACGAAUUGGAUCGGUUUGGCCGACC
UGGGCUCUCCCCAUCUGGCCUACAUUCAUCACUGCAAGCUGUGCGAUCAGGCAAUGUCUUAUCCUUUUAUUCCGCGACCAAGACUCGCGUCCAGCCUUUG
CCAAAUUACGUCUUUACCGUGGAACGAAGGAUUUUUACCAAUGGCGAGGUUCUUCGCAAUGCGGGCGGAGGACCCAGGCAGCCGCGCACGCAGCCCGUGG
CAGCACCCAAUAUACUACUUCUACGUCGCAAGAUCACGGAAGAUCAGUCCGUAUGGCAUCUGCAAUUCUAUCCAGAAACGGCGCAAACGUUCCUAUUUCA
GGUCGUGGACAUUCAGUGGUCAGUUCGCCGACCGACUUUGUCCUUUUUGGACACGUACAAAGGACGUAUGUGGUGUACUGCAACACUACAAAAGAAACAC
GGUGCCGCUUCGCAGCCGGGAGCUGGAAGGUGCUGCGGUUACACCAGAAGUAUACCCCUCCACUGUCAAAAAGAUCGUUGUGGCUGGAACCGCAUCUGUG
</pre><h1><a class="anchor" id="autotoc_md133"></a>
APPENDIX</h1>
<h1><a class="anchor" id="autotoc_md134"></a>
Combination with multi-target design</h1>
<div class="fragment"><div class="line"><span class="keyword">from</span> infrared <span class="keyword">import</span> rna</div>
<div class="line">toy_targets = [</div>
<div class="line"><span class="comment">#    012345678901234567890</span></div>
<div class="line">    <span class="stringliteral">&quot;((((...))))(((...)))&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;((((((.....)))...)))&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;......(((..)))......&quot;</span>,</div>
<div class="line"><span class="comment">#    &quot;....((((......))))..&quot;</span></div>
<div class="line">]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment"># RNAfold/3str/f3.100.0.inp</span></div>
<div class="line">benchmark_targets = [</div>
<div class="line"><span class="stringliteral">&#39;((((.((....)).)))).((.(((.((((.....(((..((((((.((..(((.(.....).)))..)).)).))))..)))..)))).))).))....&#39;</span>,</div>
<div class="line"><span class="stringliteral">&#39;..(((((.....(((.(((((((.....))))..))).))).....)))))..((((((((((...))).)....))))))...((((((....))))))&#39;</span>,</div>
<div class="line"><span class="stringliteral">&#39;......(((((.....(((...(((.((.((.(((....((......))...))).)).)))))..))).............))))).((((...)))).&#39;</span></div>
<div class="line">]</div>
<div class="line"> </div>
<div class="line">targets = toy_targets</div>
<div class="line"><span class="comment">#targets = benchmark_targets[:2]</span></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="keyword">def </span>construct_design_model(targets):</div>
<div class="line">    seqlen = len(targets[0])</div>
<div class="line">    </div>
<div class="line">    model = ir.Model()</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># one variable X_i per position i;</span></div>
<div class="line">    <span class="comment"># the value of X_i encodes the nucleotide at position i   </span></div>
<div class="line">    model.add_variables( seqlen, 4, name=<span class="stringliteral">&#39;X&#39;</span> )</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> i,target <span class="keywordflow">in</span> enumerate(targets):</div>
<div class="line">        bps = rna.parse(target)</div>
<div class="line"> </div>
<div class="line">        model.add_constraints( rna.BPComp( i, j ) <span class="keywordflow">for</span> ( i, j ) <span class="keywordflow">in</span> bps )</div>
<div class="line"> </div>
<div class="line">        model.add_functions( [ rna.BPEnergy( i, j, <span class="keyword">False</span> ) </div>
<div class="line">                               <span class="keywordflow">for</span> ( i, j ) <span class="keywordflow">in</span> bps ], group = f<span class="stringliteral">&#39;bpenergy{i}&#39;</span> )</div>
<div class="line"> </div>
<div class="line">        model.add_feature( f<span class="stringliteral">&#39;E{i}&#39;</span>, <span class="comment"># feature name</span></div>
<div class="line">                           f<span class="stringliteral">&#39;bpenergy{i}&#39;</span>, <span class="comment"># controlled group(s)</span></div>
<div class="line">                           <span class="comment">#</span></div>
<div class="line">                           <span class="comment"># function to evaluate the feature for a sample;</span></div>
<div class="line">                           <span class="comment"># NOTE how we have to bind i</span></div>
<div class="line">                           <span class="keyword">lambda</span> sample, i=i: RNA.energy_of_struct( rna.values_to_seq( sample.values() ),</div>
<div class="line">                                                  targets[i] )</div>
<div class="line">                         )</div>
<div class="line"> </div>
<div class="line">    model.add_functions( [ rna.GCCont( i = i ) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(seqlen) ], group = <span class="stringliteral">&#39;gc&#39;</span> )</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    model.write_graph(<span class="stringliteral">&#39;dependency_graph.dot&#39;</span>, <span class="keyword">True</span>)</div>
<div class="line">    ir.dotfile_to_pdf(<span class="stringliteral">&#39;dependency_graph.dot&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># the model generates automatic features &#39;bpenergyI&#39;, &#39;gc&#39; from the function groups;</span></div>
<div class="line">    <span class="comment"># as well as total feature combining all function groups;</span></div>
<div class="line">    <span class="comment"># however, we want to diretly control Turner energy (instead of base pair energy).</span></div>
<div class="line">    <span class="comment"># For this purpose, add additional features &#39;EI&#39;</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> model</div>
</div><!-- fragment --><div class="fragment"><div class="line">model = construct_design_model(targets)</div>
<div class="line"> </div>
<div class="line">sampler = ir.Sampler(model)</div>
<div class="line">print(f<span class="stringliteral">&#39;Treewidth(design): {sampler.treewidth()}&#39;</span>)</div>
<div class="line"> </div>
<div class="line">n= len(targets[0])</div>
<div class="line">print(f<span class="stringliteral">&#39;Length: {n}&#39;</span>)</div>
<div class="line"> </div>
<div class="line">model = automaton_model(n, Sigma, automaton, negated=<span class="keyword">True</span>, model=model)</div>
</div><!-- fragment --> <pre class="fragment">Treewidth(design): 1
Length: 20
</pre><div class="fragment"><div class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image</div>
<div class="line"><span class="keyword">import</span> re</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot dependency graph</span></div>
<div class="line">filename = <span class="stringliteral">&#39;dependency_graph.dot&#39;</span></div>
<div class="line">model.write_graph(filename, <span class="keyword">True</span>)</div>
<div class="line"> </div>
<div class="line">ir.dotfile_to_png(filename)</div>
<div class="line">filename = re.sub(<span class="stringliteral">r&quot;dot$&quot;</span>,<span class="stringliteral">&quot;png&quot;</span>,filename)</div>
<div class="line">Image(filename=filename,width=400)</div>
</div><!-- fragment --><p><img src="Automata_files/Automata_23_0.png" alt="png" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md135"></a>
Compute the tree decomposition - compare different strategies</h1>
<h2><a class="anchor" id="autotoc_md136"></a>
Minimize tree width</h2>
<p>Here, we additionally set a fixed number of iterations</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> treedecomp</div>
<div class="line"><span class="keyword">from</span> treedecomp <span class="keyword">import</span> NXTreeDecompositionFactory</div>
<div class="line"> </div>
<div class="line">weights = [d.size() <span class="keywordflow">for</span> d <span class="keywordflow">in</span> model.domains]</div>
<div class="line"> </div>
<div class="line">sampler = ir.Sampler(model,</div>
<div class="line">    td_factory=NXTreeDecompositionFactory(iterations=100,</div>
<div class="line">        adaptive=<span class="keywordtype">None</span>,</div>
<div class="line">        <span class="comment">#objective=&quot;weight&quot;, weights=weights</span></div>
<div class="line">    ))</div>
<div class="line">print(f<span class="stringliteral">&#39;Treewidth(design+automaton): {sampler.treewidth()}&#39;</span>)</div>
<div class="line"> </div>
<div class="line">td=sampler.td</div>
<div class="line">print(weights)</div>
<div class="line">bagweights = treedecomp._bagweights(td.bags, weights)</div>
<div class="line">print(bagweights)</div>
<div class="line">print(f<span class="stringliteral">&quot;{float(sum(bagweights)):0.2}&quot;</span>)</div>
</div><!-- fragment --> <pre class="fragment">Treewidth(design+automaton): 7
[4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4]
[65536, 4096, 16384, 16384, 65536, 65536, 16384, 16384, 4096, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 256, 256, 256, 256, 256, 256, 256, 256, 64, 64, 64, 64, 16, 64, 64, 4, 16, 64, 256, 1024, 4096, 16384]
3e+05
</pre><h2><a class="anchor" id="autotoc_md137"></a>
Minimize tree width after 'collapsing' corresponding variables</h2>
<p>This is useful to more easily argue worst case bounds in the context of series of corresponding variables with different domain sizes (here, for general FDA, this is the case for X_i and Y_i, which correspond to each other). In practice, this often seems to be significantly worse.</p>
<p>Note that domain sizes happen to be almost uniform for the stop codon automaton.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> treedecomp</div>
<div class="line"><span class="keyword">from</span> treedecomp <span class="keyword">import</span> NXTreeDecompositionFactory</div>
<div class="line"> </div>
<div class="line">n= len(targets[0])</div>
<div class="line"> </div>
<div class="line">weights = [d.size() <span class="keywordflow">for</span> d <span class="keywordflow">in</span> model.domains]</div>
<div class="line"> </div>
<div class="line">sampler = ir.Sampler(model,</div>
<div class="line">    td_factory=NXTreeDecompositionFactory(iterations=100,</div>
<div class="line">        adaptive=<span class="keywordtype">None</span>,</div>
<div class="line">        join = <span class="keyword">lambda</span> i,j: i&lt;n <span class="keywordflow">and</span> j==i+n,</div>
<div class="line">        <span class="comment">#objective=&quot;weight&quot;, weights=weights</span></div>
<div class="line">    ))</div>
<div class="line">print(f<span class="stringliteral">&#39;Treewidth(design+automaton): {sampler.treewidth()}&#39;</span>)</div>
<div class="line"> </div>
<div class="line">td=sampler.td</div>
<div class="line">print(weights)</div>
<div class="line">bagweights = treedecomp._bagweights(td.bags, weights)</div>
<div class="line">print(bagweights)</div>
<div class="line">print(f<span class="stringliteral">&quot;{float(sum(bagweights)):0.2}&quot;</span>)</div>
</div><!-- fragment --> <pre class="fragment">Treewidth(design+automaton): 11
[4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4]
[16777216, 1048576, 1048576, 16777216, 1048576, 65536, 65536, 1048576, 1048576, 262144, 16384, 16384, 4096, 4096, 4096, 64, 4, 16, 64, 256, 1024, 4096, 16384, 65536, 262144, 1048576, 4194304, 4194304, 16384, 1024, 1024, 1024, 262144, 262144, 262144, 262144, 4096, 4096, 262144, 16384, 262144]
5.1e+07
</pre><h2><a class="anchor" id="autotoc_md138"></a>
Optimize weight over tree decompositions with low tree width (from min-fill-in)</h2>
<p>Experimental feature. Finally, it would be desirable to optimize weight, i.e. the sum over the products of domain sizes per bag, over all possible tree decompositions. This strategy nevertheless typically improves evaluation-time over the non-weighted strategy in the context of non-uniform domain sizes.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> treedecomp</div>
<div class="line"><span class="keyword">from</span> treedecomp <span class="keyword">import</span> NXTreeDecompositionFactory</div>
<div class="line"> </div>
<div class="line">weights = [d.size() <span class="keywordflow">for</span> d <span class="keywordflow">in</span> model.domains]</div>
<div class="line">sampler = ir.Sampler(model,</div>
<div class="line">    td_factory=NXTreeDecompositionFactory(iterations=100,</div>
<div class="line">        adaptive=<span class="keywordtype">None</span>,</div>
<div class="line">        objective=<span class="stringliteral">&quot;weight&quot;</span>,</div>
<div class="line">        weights=weights))</div>
<div class="line">print(f<span class="stringliteral">&#39;Treewidth(design+automaton): {sampler.treewidth()}&#39;</span>)</div>
<div class="line"> </div>
<div class="line">td=sampler.td</div>
<div class="line">print(weights)</div>
<div class="line">bagweights = treedecomp._bagweights(td.bags, weights)</div>
<div class="line">print(bagweights)</div>
<div class="line">print(f<span class="stringliteral">&quot;{float(sum(bagweights)):0.2}&quot;</span>)</div>
</div><!-- fragment --> <pre class="fragment">Treewidth(design+automaton): 7
[4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4]
[65536, 16384, 16384, 65536, 16384, 16384, 16384, 4096, 16384, 4096, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 256, 256, 256, 256, 256, 256, 256, 256, 64, 64, 64, 64, 64, 64, 16, 4, 16, 64, 256, 1024, 4096, 16384]
2.7e+05
</pre><div class="fragment"><div class="line"><span class="comment"># Plot tree decomposition</span></div>
<div class="line">filename=<span class="stringliteral">&quot;treedecomp&quot;</span></div>
<div class="line">sampler.plot_td(filename,<span class="stringliteral">&#39;png&#39;</span>)</div>
<div class="line">Image(filename=filename+<span class="stringliteral">&quot;.png&quot;</span>,width=600)</div>
</div><!-- fragment --><p><img src="Automata_files/Automata_31_0.png" alt="png" class="inline"/></p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> target <span class="keywordflow">in</span> targets:</div>
<div class="line">    print(target)</div>
<div class="line"><span class="keywordflow">for</span> sample <span class="keywordflow">in</span> (sampler.sample() <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(10)):</div>
<div class="line">    seq = a_to_seq(sample,n,<span class="stringliteral">&quot;ACGU&quot;</span>)</div>
<div class="line">    print(seq)</div>
</div><!-- fragment --> <pre class="fragment">((((...))))(((...)))
((((((.....)))...)))
......(((..)))......
GUACGUCGUACGUGCGUUAU
GCGCAUCGCGCGUGGAACGU
GUGUGUCGUACGUGGGUCAU
UGUGCAGCAUGUGCAACGCG
UAUGUGGCGUGCGUGGUAUG
UGUACAGUACGUGUCAGAUG
GUAUACUAUGUGUAUCAUGC
UGUGCAGUGCAUGUACCGUA
GUGUGUUGUGCAUGUGCUAU
GUGUGUUAUGUGUGUAUUAU
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
